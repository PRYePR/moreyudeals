# Sparhamster æŠ“å–ç³»ç»Ÿ - API æ”¹é€ æ–¹æ¡ˆ

> ç‰ˆæœ¬: v2.0
> åˆ›å»ºæ—¶é—´: 2025-11-11
> å®Œæˆæ—¶é—´: 2025-11-11
> çŠ¶æ€: âœ… å·²å®Œæˆå¹¶ä¸Šçº¿

## ğŸ“‹ ç›®å½•

1. [èƒŒæ™¯å’Œé—®é¢˜](#èƒŒæ™¯å’Œé—®é¢˜)
2. [æ”¹é€ ç›®æ ‡](#æ”¹é€ ç›®æ ‡)
3. [æŠ€æœ¯æ–¹æ¡ˆ](#æŠ€æœ¯æ–¹æ¡ˆ)
4. [æ•°æ®æµç¨‹](#æ•°æ®æµç¨‹)
5. [é™çº§ç­–ç•¥](#é™çº§ç­–ç•¥)
6. [å®æ–½è®¡åˆ’](#å®æ–½è®¡åˆ’)
7. [æµ‹è¯•æ–¹æ¡ˆ](#æµ‹è¯•æ–¹æ¡ˆ)

---

## èƒŒæ™¯å’Œé—®é¢˜

### å½“å‰é—®é¢˜

1. **API é™åˆ¶é—®é¢˜**
   - Sparhamster å¼€å§‹é˜²èŒƒ API æŠ“å–
   - ä½¿ç”¨ `_embed=true` å‚æ•°å¯¼è‡´ 500 é”™è¯¯
   - ç§»é™¤ `_embed=true` åç¼ºå°‘å…³é”®å•†å®¶ä¿¡æ¯

2. **æ•°æ®å‡†ç¡®æ€§é—®é¢˜**
   - API ä»·æ ¼ä¿¡æ¯ä¸å‡†ç¡®ï¼ˆæœ‰æ—¶å°†è¿è´¹å½“ä½œä»·æ ¼ï¼‰
   - API æ ‡é¢˜å¯èƒ½ä¸å¤Ÿå‡†ç¡®
   - API ç¼ºå°‘å•†å®¶åç§°å’Œ Logo

3. **å·²æœ‰æ•°æ®æŸå**
   - æ•°æ®åº“ä¸­å•†å®¶åç§°æ˜¾ç¤ºä¸ºäº§å“åç§°
   - å¯¼è‡´ Amazon è”ç›Ÿé“¾æ¥å¤„ç†å¤±è´¥
   - å½±å“å‰ç«¯å±•ç¤ºæ•ˆæœ

### æ ¸å¿ƒæ´å¯Ÿ

**é¦–é¡µ HTML æ¯” API æ›´å¯é **ï¼š
- âœ… ä»·æ ¼ä¿¡æ¯å‡†ç¡®ï¼ˆä»å®é™…å±•ç¤ºæå–ï¼‰
- âœ… å•†å®¶ä¿¡æ¯å®Œæ•´ï¼ˆåç§° + Logoï¼‰
- âœ… Forward é“¾æ¥å‡†ç¡®ï¼ˆçœŸå®è·³è½¬é“¾æ¥ï¼‰
- âœ… æ´»åŠ¨ä¿¡æ¯å®Œæ•´ï¼ˆå‰©ä½™æ—¶é—´ã€ä¼˜æƒ ç ï¼‰
- âŒ ç¼ºå°‘æ–‡ç« è¯¦ç»†å†…å®¹å’Œæ‘˜è¦

---

## æ”¹é€ ç›®æ ‡

### æ ¸å¿ƒåŸåˆ™

1. **æ•°æ®å‡†ç¡®æ€§ä¼˜å…ˆ** - ä»¥é¦–é¡µ HTML ä¸ºä¸»è¦æ•°æ®æº
2. **æ•ˆç‡ä¸ç¨³å®šæ€§å¹¶é‡** - API å¿«é€Ÿåˆ¤æ–­æ›´æ–°ï¼ŒHTML è¡¥å……å®Œæ•´æ•°æ®
3. **æ™ºèƒ½é™çº§** - API å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢çº¯ HTML æ¨¡å¼
4. **å®¹é”™æœºåˆ¶** - ç¼ºå¤±å†…å®¹æ”¯æŒåç»­è¡¥å…¨

### ç›®æ ‡æŒ‡æ ‡

- æŠ“å–æˆåŠŸç‡: â‰¥ 99%
- æ•°æ®å‡†ç¡®ç‡: 100%
- å¹³å‡æŠ“å–æ—¶é—´: â‰¤ 10ç§’
- API é™çº§æ¢å¤æ—¶é—´: 24å°æ—¶

---

## æŠ€æœ¯æ–¹æ¡ˆ

### æ–¹æ¡ˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Step 1: API å¿«é€Ÿæ£€æµ‹                       â”‚
â”‚  - æŠ“å– 20 æ¡æœ€æ–°æ–‡ç«                                           â”‚
â”‚  - æå–: post_id, content_html, æ—¶é—´                         â”‚
â”‚  - åˆ¤æ–­æ–°æ–‡ç« æ•°é‡                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                      â”‚
    API æˆåŠŸ                                API å¤±è´¥
         â”‚                                      â”‚
         â†“                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ–°æ–‡ç« æ•°é‡ > 0ï¼Ÿ    â”‚              â”‚  è®°å½•å¤±è´¥æ¬¡æ•°        â”‚
â”‚  â”œâ”€ æ˜¯ â†’ ç»§ç»­        â”‚              â”‚  è¿ç»­å¤±è´¥ < 3æ¬¡      â”‚
â”‚  â””â”€ å¦ â†’ è·³è¿‡æ‰€æœ‰    â”‚              â”‚  â†’ ä»…æŠ¥è­¦            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚                     â”‚
         â”‚                            â”‚  è¿ç»­å¤±è´¥ â‰¥ 3æ¬¡      â”‚
         â†“                            â”‚  â†’ åˆ‡æ¢çº¯HTMLæ¨¡å¼    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Step 2: HTML æŠ“å–ï¼ˆæ ¹æ®æ–°æ–‡ç« æ•°é‡ï¼‰               â”‚
â”‚  - æ–°æ–‡ç«  > 5 â†’ ç»§ç»­æŠ“ä¸‹ä¸€é¡µ                                  â”‚
â”‚  - æ–°æ–‡ç«  â‰¤ 5 â†’ åœæ­¢                                         â”‚
â”‚  - æœ€å¤š 3 é¡µ                                                 â”‚
â”‚  - é¡µé—´å»¶è¿Ÿ 3-10 ç§’ï¼ˆæ¨¡æ‹Ÿäººç±»ï¼‰                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                            â”‚
         â†“                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: æ•°æ®åˆå¹¶    â”‚    â”‚  çº¯HTMLæ¨¡å¼ï¼ˆ24å°æ—¶ï¼‰             â”‚
â”‚  - HTML è¦†ç›– API    â”‚    â”‚  1. é€é¡µæŠ“å–ï¼ˆæœ€å¤š3é¡µï¼‰           â”‚
â”‚  - API æä¾›å†…å®¹     â”‚    â”‚  2. æ–°æ–‡ç« >5 â†’ ç»§ç»­              â”‚
â”‚  - HTML æä¾›å…¶ä»–    â”‚    â”‚  3. æ–°æ–‡ç« â‰¤5 â†’ åœæ­¢              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  4. ç¼ºå¤±contentæ ‡è®°ä¸ºmissing     â”‚
         â”‚                  â”‚  5. 24å°æ—¶åè‡ªåŠ¨æ¢å¤å°è¯•API       â”‚
         â†“                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Step 4: å•†å®¶è¯†åˆ«å’Œè”ç›Ÿé“¾æ¥å¤„ç†                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Step 5: å»é‡æ£€æŸ¥å’Œå…¥åº“                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Step 6: ç¿»è¯‘æœåŠ¡ï¼ˆå¼‚æ­¥ï¼‰                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æºä¼˜å…ˆçº§

| å­—æ®µ | ä¸»è¦æ¥æº | å¤‡é€‰æ¥æº | è¯´æ˜ |
|------|---------|---------|------|
| **post_id** | API | HTML | ç”¨äºåŒ¹é…å’Œå»é‡ |
| **content_html** | API | âŒ | æ–‡ç« è¯¦ç»†å†…å®¹ï¼ˆå¿…éœ€ï¼‰ |
| **excerpt** | âŒ ä¸éœ€è¦ | - | å‰ç«¯ä¸ä½¿ç”¨ |
| **å‘å¸ƒæ—¶é—´** | API | HTML `<meta datePublished>` | ISOæ ¼å¼ |
| **æ›´æ–°æ—¶é—´** | API | HTML `<meta dateModified>` | ISOæ ¼å¼ |
| **æ ‡é¢˜** | HTML | API | HTMLæ›´å‡†ç¡® |
| **ä»·æ ¼** | HTML `.post-price` | âŒ | HTMLå‡†ç¡®ï¼ŒAPIå¯èƒ½é”™è¯¯ |
| **åŸä»·** | HTML `line-through` | âŒ | åˆ’çº¿ä»·æ ¼ |
| **æŠ˜æ‰£** | HTML `.has-blue-color` | è®¡ç®— | ç™¾åˆ†æ¯” |
| **å•†å®¶åç§°** | HTML `<a title>` | âŒ | å»æ‰åç¼€ |
| **å•†å®¶Logo** | HTML `data-lazy-src` | âŒ | /images/shops/ |
| **Forwardé“¾æ¥** | HTML | âŒ | éœ€è§£ç  &amp; |
| **ä¼˜æƒ ç ** | HTML `.couponCode` | API | HTMLæ›´ç›´è§‚ |
| **å•†å“å›¾ç‰‡** | HTML | API | wp-content/uploads |
| **åˆ†ç±»æ ‡ç­¾** | HTML `class` | âŒ | category-xxx |
| **æ´»åŠ¨å‰©ä½™æ—¶é—´** | HTML | âŒ | "noch X Stunden" |
| **æ–‡ç« é“¾æ¥** | HTML | API | è¯¦æƒ…é¡µåœ°å€ |

---

## æ•°æ®æµç¨‹

### æ­£å¸¸æ¨¡å¼ï¼ˆAPI + HTMLï¼‰

```javascript
// 1. API æŠ“å–ï¼ˆå¿«é€Ÿæ£€æµ‹ï¼‰
const apiResponse = await axios.get('/wp-json/wp/v2/posts?per_page=20');
const posts = apiResponse.data;

// 2. æå–å…³é”®ä¿¡æ¯
const apiData = posts.map(post => ({
  postId: post.id.toString(),
  contentHtml: post.content.rendered,
  publishedAt: new Date(post.date),
  modifiedAt: new Date(post.modified),
  link: post.link,
}));

// 3. åˆ¤æ–­æ–°æ–‡ç« 
const newPosts = apiData.filter(post => !existsInDatabase(post.postId));
const newCount = newPosts.length;

if (newCount === 0) {
  console.log('âœ“ æ— æ–°æ–‡ç« ï¼Œè·³è¿‡æŠ“å–');
  return;
}

// 4. è®¡ç®—éœ€è¦æŠ“å–çš„ HTML é¡µæ•°
let pagesToFetch = 1;
if (newCount > 5) pagesToFetch = 2;
if (newCount > 15) pagesToFetch = 3;

console.log(`ğŸ“„ å‘ç° ${newCount} ç¯‡æ–°æ–‡ç« ï¼ŒæŠ“å– ${pagesToFetch} é¡µ HTML`);

// 5. æŠ“å– HTMLï¼ˆåˆ†é¡µï¼‰
const htmlArticles = [];
for (let page = 1; page <= pagesToFetch; page++) {
  if (page > 1) {
    await randomDelay(3000, 10000); // 3-10ç§’å»¶è¿Ÿ
  }
  const html = await fetchPage(page);
  const articles = parseArticles(html);
  htmlArticles.push(...articles);

  // åŠ¨æ€åˆ¤æ–­ï¼šå½“å‰é¡µæ–°æ–‡ç« æ˜¯å¦ > 5
  const pageNewCount = articles.filter(a => !existsInDatabase(a.postId)).length;
  if (pageNewCount <= 5 && page < pagesToFetch) {
    console.log(`ğŸ“Š ç¬¬${page}é¡µæ–°æ–‡ç« ä»… ${pageNewCount} ç¯‡ï¼Œæå‰åœæ­¢`);
    break;
  }
}

// 6. åˆå¹¶æ•°æ®ï¼ˆHTML è¦†ç›– APIï¼‰
const mergedDeals = apiData.map(apiPost => {
  const htmlData = htmlArticles.find(h => h.postId === apiPost.postId);

  return {
    // API æä¾›ï¼ˆä¸è¢«è¦†ç›–ï¼‰
    contentHtml: apiPost.contentHtml,
    publishedAt: apiPost.publishedAt,
    modifiedAt: apiPost.modifiedAt,
    contentStatus: 'complete',

    // HTML è¦†ç›–ï¼ˆä¼˜å…ˆçº§æ›´é«˜ï¼‰
    title: htmlData?.title || '',
    price: htmlData?.price,
    originalPrice: htmlData?.originalPrice,
    discount: htmlData?.discount,
    merchant: htmlData?.merchant,
    merchantLogo: htmlData?.merchantLogo,
    merchantLink: htmlData?.merchantLink,
    couponCode: htmlData?.couponCode,
    imageUrl: htmlData?.imageUrl,
    categories: htmlData?.categories,
    expiresIn: htmlData?.expiresIn, // æ´»åŠ¨å‰©ä½™æ—¶é—´

    // å…ƒæ•°æ®
    sourceSite: 'sparhamster',
    sourcePostId: apiPost.postId,
    link: htmlData?.link || apiPost.link,
  };
});
```

### é™çº§æ¨¡å¼ï¼ˆçº¯ HTMLï¼‰

```javascript
// API è¿ç»­å¤±è´¥ â‰¥ 3 æ¬¡ï¼Œåˆ‡æ¢çº¯ HTML æ¨¡å¼ï¼ˆä¿æŒ 24 å°æ—¶ï¼‰

console.log('âš ï¸ API è¿ç»­å¤±è´¥ 3 æ¬¡ï¼Œåˆ‡æ¢çº¯ HTML æ¨¡å¼');

const htmlArticles = [];
let page = 1;
const maxPages = 3;

while (page <= maxPages) {
  if (page > 1) {
    await randomDelay(3000, 10000);
  }

  const html = await fetchPage(page);
  const articles = parseArticles(html);

  // åˆ¤æ–­æ–°æ–‡ç« æ•°é‡
  const newCount = articles.filter(a => !existsInDatabase(a.postId)).length;
  htmlArticles.push(...articles);

  console.log(`ğŸ“„ ç¬¬${page}é¡µ: ${articles.length} ç¯‡æ–‡ç« ï¼Œ${newCount} ç¯‡æ–°æ–‡ç« `);

  // åŠ¨æ€åˆ¤æ–­æ˜¯å¦ç»§ç»­
  if (newCount <= 5) {
    console.log('âœ“ æ–°æ–‡ç« æ•°é‡ â‰¤ 5ï¼Œåœæ­¢æŠ“å–');
    break;
  }

  page++;
}

// å¤„ç†æ•°æ®ï¼ˆç¼ºå°‘ content_htmlï¼‰
const deals = htmlArticles.map(article => ({
  // HTML æä¾›
  title: article.title,
  price: article.price,
  originalPrice: article.originalPrice,
  discount: article.discount,
  merchant: article.merchant,
  merchantLogo: article.merchantLogo,
  merchantLink: article.merchantLink,
  couponCode: article.couponCode,
  imageUrl: article.imageUrl,
  categories: article.categories,
  publishedAt: article.publishedAt,
  modifiedAt: article.modifiedAt,
  expiresIn: article.expiresIn,

  // ç¼ºå¤±å­—æ®µ
  contentHtml: undefined,
  contentStatus: 'missing', // æ ‡è®°ä¸ºç¼ºå¤±

  // å…ƒæ•°æ®
  sourceSite: 'sparhamster',
  sourcePostId: article.postId,
  link: article.link,
}));

// 24 å°æ—¶åè‡ªåŠ¨æ¢å¤å°è¯• API
scheduleApiRetry(Date.now() + 24 * 60 * 60 * 1000);
```

---

## é™çº§ç­–ç•¥

### å¤±è´¥æ£€æµ‹å’Œåˆ‡æ¢

```javascript
class ApiHealthMonitor {
  private consecutiveFailures = 0;
  private lastFailureTime?: Date;
  private degradedMode = false;
  private degradedUntil?: Date;

  async checkHealth(): Promise<'healthy' | 'degraded'> {
    // å¦‚æœåœ¨é™çº§æœŸé—´ï¼Œæ£€æŸ¥æ˜¯å¦åˆ°æœŸ
    if (this.degradedMode && this.degradedUntil) {
      if (Date.now() >= this.degradedUntil.getTime()) {
        console.log('âœ“ é™çº§æ¨¡å¼åˆ°æœŸï¼Œå°è¯•æ¢å¤ API');
        this.degradedMode = false;
        this.consecutiveFailures = 0;
        return 'healthy';
      }
      return 'degraded';
    }

    // æ­£å¸¸æ¨¡å¼ï¼Œæ£€æŸ¥å¤±è´¥æ¬¡æ•°
    if (this.consecutiveFailures >= 3) {
      console.warn('âš ï¸ API è¿ç»­å¤±è´¥ 3 æ¬¡ï¼Œåˆ‡æ¢é™çº§æ¨¡å¼ï¼ˆ24å°æ—¶ï¼‰');
      this.degradedMode = true;
      this.degradedUntil = new Date(Date.now() + 24 * 60 * 60 * 1000);
      return 'degraded';
    }

    return 'healthy';
  }

  recordSuccess(): void {
    this.consecutiveFailures = 0;
    this.lastFailureTime = undefined;
  }

  recordFailure(): void {
    this.consecutiveFailures++;
    this.lastFailureTime = new Date();
    console.warn(`âš ï¸ API å¤±è´¥æ¬¡æ•°: ${this.consecutiveFailures}/3`);
  }
}
```

### æ¢å¤æœºåˆ¶

```javascript
// å®šæœŸå°è¯•æ¢å¤ï¼ˆæ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡ï¼‰
setInterval(async () => {
  const health = await healthMonitor.checkHealth();

  if (health === 'degraded') {
    console.log('â¸ï¸ å½“å‰å¤„äºé™çº§æ¨¡å¼ï¼Œç­‰å¾…æ¢å¤æ—¶é—´');
    return;
  }

  // å°è¯•è°ƒç”¨ API
  try {
    const response = await axios.get('/wp-json/wp/v2/posts?per_page=1', { timeout: 5000 });
    if (response.status === 200) {
      console.log('âœ“ API æ¢å¤æ­£å¸¸');
      healthMonitor.recordSuccess();
    }
  } catch (error) {
    console.warn('âœ— API ä»ç„¶å¤±è´¥');
    healthMonitor.recordFailure();
  }
}, 60 * 60 * 1000); // æ¯å°æ—¶
```

---

## å®æ–½è®¡åˆ’

### Phase 1: æ•°æ®åº“æ”¹é€ ï¼ˆå‡†å¤‡é˜¶æ®µï¼‰

**ç›®æ ‡**: æ”¯æŒå†…å®¹ç¼ºå¤±å’Œè¡¥å…¨æœºåˆ¶

```sql
-- 1. æ·»åŠ  content_status å­—æ®µ
ALTER TABLE deals ADD COLUMN content_status VARCHAR(20) DEFAULT 'complete';
-- å¯é€‰å€¼: 'complete', 'missing', 'pending'

-- 2. æ·»åŠ ç´¢å¼•ï¼ˆä¼˜åŒ–æŸ¥è¯¢ç¼ºå¤±å†…å®¹çš„è®°å½•ï¼‰
CREATE INDEX idx_deals_content_status ON deals(content_status);
CREATE INDEX idx_deals_source_post_id ON deals(source_site, source_post_id);

-- 3. æ ‡è®°ç°æœ‰ç¼ºå¤±å†…å®¹çš„è®°å½•
UPDATE deals
SET content_status = 'missing'
WHERE (content_html IS NULL OR content_html = '')
  AND source_site = 'sparhamster';
```

**é¢„æœŸæ—¶é—´**: 1 å°æ—¶

### Phase 2: Homepage Fetcher å¢å¼ºï¼ˆæ ¸å¿ƒæ”¹é€ ï¼‰

**ç›®æ ‡**: æå–æ‰€æœ‰éœ€è¦çš„ HTML å­—æ®µ

**æ–‡ä»¶**: `packages/worker/src/services/homepage-fetcher.ts`

**æ–°å¢æå–å­—æ®µ**:
```typescript
export interface HomepageArticle {
  postId: string;           // âœ“ å·²æœ‰
  slug?: string;            // âœ“ å·²æœ‰
  merchantLink?: string;    // âœ“ å·²æœ‰
  merchantLogo?: string;    // âœ“ å·²æœ‰

  // æ–°å¢å­—æ®µ
  merchant?: string;        // å•†å®¶åç§°ï¼ˆä» title æå–ï¼‰
  title?: string;           // æ–‡ç« æ ‡é¢˜
  price?: number;           // ç°ä»·
  originalPrice?: number;   // åŸä»·
  discount?: number;        // æŠ˜æ‰£ç™¾åˆ†æ¯”
  couponCode?: string;      // ä¼˜æƒ ç 
  imageUrl?: string;        // å•†å“å›¾ç‰‡
  categories?: string[];    // åˆ†ç±»æ ‡ç­¾
  expiresIn?: string;       // æ´»åŠ¨å‰©ä½™æ—¶é—´ï¼ˆå¦‚ "noch 23 Stunden"ï¼‰
  publishedAt?: Date;       // å‘å¸ƒæ—¶é—´
  modifiedAt?: Date;        // æ›´æ–°æ—¶é—´
  link?: string;            // æ–‡ç« è¯¦æƒ…é¡µé“¾æ¥
}
```

**å…³é”®å®ç°**:
```typescript
private parseArticles(html: string): HomepageArticle[] {
  const $ = cheerio.load(html);
  const articles: HomepageArticle[] = [];

  $('article.post').each((_, elem) => {
    const article = $(elem);

    // 1. Post ID
    const postId = article.attr('id')?.replace('post-', '') || '';

    // 2. å•†å®¶åç§°ï¼ˆä» title æå–ï¼Œå»æ‰åç¼€ï¼‰
    const shopLink = article.find('a[href*="/shop/"]').first();
    const titleAttr = shopLink.attr('title') || '';
    const merchant = titleAttr.replace(/\s*(Gutscheine|Angebote|&\s*Angebote).*$/i, '').trim();

    // 3. å•†å®¶ Logo
    const logoImg = article.find('img[src*="/images/shops/"], img[data-lazy-src*="/images/shops/"]').first();
    const merchantLogo = logoImg.attr('data-lazy-src') || logoImg.attr('src');

    // 4. æ ‡é¢˜
    const titleLink = article.find('h2 a, a.article-title').first();
    const title = titleLink.text().trim();
    const link = titleLink.attr('href');

    // 5. ä»·æ ¼ä¿¡æ¯
    const priceDiv = article.find('.post-price.has-blue-color').first();
    const priceText = priceDiv.text().trim();
    const price = this.parsePrice(priceText); // 13,14 â‚¬ â†’ 13.14

    const originalPriceSpan = article.find('span[style*="line-through"]').first();
    const originalPriceText = originalPriceSpan.text().trim();
    const originalPrice = this.parsePrice(originalPriceText); // 18,37 â‚¬ â†’ 18.37

    const discountSpan = article.find('.has-blue-color').filter((_, el) => {
      return $(el).text().includes('Ersparnis');
    }).first();
    const discountMatch = discountSpan.text().match(/(\d+)\s*%/);
    const discount = discountMatch ? parseInt(discountMatch[1]) : undefined;

    // 6. Forward é“¾æ¥ï¼ˆè§£ç  HTML å®ä½“ï¼‰
    let merchantLink = article.find('a[href*="forward.sparhamster.at"]').first().attr('href');
    if (merchantLink) {
      merchantLink = this.decodeHtmlEntities(merchantLink);
    }

    // 7. ä¼˜æƒ ç 
    const couponDiv = article.find('.couponCode').first();
    const couponCode = couponDiv.text().trim() || undefined;

    // 8. å•†å“å›¾ç‰‡
    const productImg = article.find('img[src*="wp-content/uploads"]')
      .not('img[src*="/images/shops/"]')
      .first();
    const imageUrl = productImg.attr('data-lazy-src') || productImg.attr('src');

    // 9. åˆ†ç±»æ ‡ç­¾ï¼ˆä» class æå–ï¼‰
    const classes = article.attr('class') || '';
    const categories = [...classes.matchAll(/category-([^\s]+)/g)]
      .map(m => m[1])
      .filter(c => c !== 'schnaeppchen'); // è¿‡æ»¤é€šç”¨æ ‡ç­¾

    // 10. æ´»åŠ¨å‰©ä½™æ—¶é—´
    const expiresInDiv = article.find('.uk-text-muted:contains("noch")').first();
    const expiresIn = expiresInDiv.text().trim() || undefined;

    // 11. æ—¶é—´ä¿¡æ¯
    const publishedMeta = article.find('meta[property="datePublished"]');
    const modifiedMeta = article.find('meta[property="dateModified"]');
    const publishedAt = publishedMeta.attr('content') ? new Date(publishedMeta.attr('content')!) : undefined;
    const modifiedAt = modifiedMeta.attr('content') ? new Date(modifiedMeta.attr('content')!) : undefined;

    articles.push({
      postId,
      merchant,
      merchantLogo,
      merchantLink,
      title,
      link,
      price,
      originalPrice,
      discount,
      couponCode,
      imageUrl,
      categories,
      expiresIn,
      publishedAt,
      modifiedAt,
    });
  });

  return articles;
}

// ä»·æ ¼è§£æï¼ˆå¾·è¯­æ ¼å¼ï¼š1.108,24 â†’ 1108.24ï¼‰
private parsePrice(priceText: string): number | undefined {
  if (!priceText) return undefined;

  // æå–æ•°å­—éƒ¨åˆ†ï¼š13,14 â‚¬ â†’ 13,14
  const match = priceText.match(/([\d.,\s]+)\s*â‚¬/);
  if (!match) return undefined;

  let cleaned = match[1].replace(/\s+/g, ''); // åˆ é™¤ç©ºæ ¼

  // å¾·è¯­æ ¼å¼ï¼šåƒä½ç”¨ç‚¹ï¼Œå°æ•°ç”¨é€—å·
  const lastComma = cleaned.lastIndexOf(',');
  const lastDot = cleaned.lastIndexOf('.');

  if (lastComma > lastDot) {
    // æœ€åæ˜¯é€—å· â†’ é€—å·æ˜¯å°æ•°ç‚¹
    cleaned = cleaned.replace(/\./g, '').replace(',', '.');
  } else {
    // æœ€åæ˜¯ç‚¹ â†’ ç‚¹æ˜¯å°æ•°ç‚¹
    cleaned = cleaned.replace(/,/g, '');
  }

  return parseFloat(cleaned) || undefined;
}
```

**é¢„æœŸæ—¶é—´**: 4-6 å°æ—¶

### Phase 3: Fetcher æ™ºèƒ½é™çº§é€»è¾‘

**ç›®æ ‡**: å®ç° API å¥åº·æ£€æµ‹å’Œè‡ªåŠ¨é™çº§

**æ–‡ä»¶**: `packages/worker/src/fetchers/sparhamster-fetcher.ts`

**æ ¸å¿ƒæ”¹åŠ¨**:
```typescript
export class SparhamsterFetcher {
  private healthMonitor: ApiHealthMonitor;

  async fetchLatest(): Promise<FetchResult> {
    // 1. æ£€æŸ¥ API å¥åº·çŠ¶æ€
    const health = await this.healthMonitor.checkHealth();

    if (health === 'degraded') {
      console.log('âš ï¸ å½“å‰å¤„äºé™çº§æ¨¡å¼ï¼Œä½¿ç”¨çº¯ HTML æŠ“å–');
      return await this.fetchFromHtmlOnly();
    }

    // 2. å°è¯• API æŠ“å–
    try {
      const result = await this.fetchFromApi();
      this.healthMonitor.recordSuccess();
      return result;
    } catch (error) {
      console.error('âŒ API æŠ“å–å¤±è´¥:', error);
      this.healthMonitor.recordFailure();

      // å¦‚æœè¾¾åˆ°é™çº§é˜ˆå€¼ï¼Œåˆ‡æ¢æ¨¡å¼
      const newHealth = await this.healthMonitor.checkHealth();
      if (newHealth === 'degraded') {
        console.log('âš ï¸ å·²åˆ‡æ¢åˆ°é™çº§æ¨¡å¼');
        return await this.fetchFromHtmlOnly();
      }

      throw error;
    }
  }

  // API + HTML æ··åˆæ¨¡å¼
  private async fetchFromApi(): Promise<FetchResult> {
    // æ­¥éª¤åŒä¹‹å‰çš„ "æ­£å¸¸æ¨¡å¼" æµç¨‹
  }

  // çº¯ HTML æ¨¡å¼
  private async fetchFromHtmlOnly(): Promise<FetchResult> {
    // æ­¥éª¤åŒä¹‹å‰çš„ "é™çº§æ¨¡å¼" æµç¨‹
  }
}
```

**é¢„æœŸæ—¶é—´**: 3-4 å°æ—¶

### Phase 4: å†…å®¹è¡¥å…¨æœºåˆ¶

**ç›®æ ‡**: å®šæœŸè¡¥å…¨ç¼ºå¤±çš„å†…å®¹

**æ–‡ä»¶**: æ–°å»º `packages/worker/src/services/content-backfill-service.ts`

```typescript
export class ContentBackfillService {
  /**
   * è¡¥å…¨ç¼ºå¤±çš„å†…å®¹ï¼ˆå½“ API æ¢å¤æ—¶ï¼‰
   */
  async backfillMissingContent(): Promise<void> {
    // 1. æŸ¥è¯¢ç¼ºå¤±å†…å®¹çš„è®°å½•
    const missingDeals = await this.database.query(`
      SELECT id, source_post_id
      FROM deals
      WHERE content_status = 'missing'
        AND source_site = 'sparhamster'
      LIMIT 50
    `);

    if (missingDeals.length === 0) {
      console.log('âœ“ æ²¡æœ‰éœ€è¦è¡¥å…¨çš„å†…å®¹');
      return;
    }

    console.log(`ğŸ“ å°è¯•è¡¥å…¨ ${missingDeals.length} æ¡ç¼ºå¤±å†…å®¹`);

    // 2. æ‰¹é‡è°ƒç”¨ API
    const postIds = missingDeals.map(d => d.source_post_id).join(',');

    try {
      const response = await axios.get(
        `/wp-json/wp/v2/posts?include=${postIds}&per_page=50`
      );

      // 3. æ›´æ–°æ•°æ®åº“
      for (const post of response.data) {
        const contentHtml = post.content.rendered;

        await this.database.query(`
          UPDATE deals
          SET content_html = $1,
              content_status = 'complete',
              updated_at = NOW()
          WHERE source_post_id = $2
            AND source_site = 'sparhamster'
        `, [contentHtml, post.id.toString()]);

        // è§¦å‘ç¿»è¯‘
        await this.triggerTranslation(post.id.toString());
      }

      console.log(`âœ“ æˆåŠŸè¡¥å…¨ ${response.data.length} æ¡å†…å®¹`);

    } catch (error) {
      console.error('âŒ å†…å®¹è¡¥å…¨å¤±è´¥:', error);
    }
  }

  /**
   * è§¦å‘ç¿»è¯‘ï¼ˆé‡ç½®ä¸º pendingï¼‰
   */
  private async triggerTranslation(sourcePostId: string): Promise<void> {
    await this.database.query(`
      UPDATE deals
      SET translation_status = 'pending'
      WHERE source_post_id = $1
        AND source_site = 'sparhamster'
        AND translation_status IN ('failed', 'completed')
    `, [sourcePostId]);
  }
}
```

**å®šæ—¶ä»»åŠ¡**:
```typescript
// æ¯ 6 å°æ—¶å°è¯•è¡¥å…¨ä¸€æ¬¡
setInterval(async () => {
  if (healthMonitor.checkHealth() === 'healthy') {
    await backfillService.backfillMissingContent();
  }
}, 6 * 60 * 60 * 1000);
```

**é¢„æœŸæ—¶é—´**: 2-3 å°æ—¶

### Phase 5: æµ‹è¯•å’Œè°ƒè¯•

**ç›®æ ‡**: éªŒè¯æ‰€æœ‰åŠŸèƒ½æ­£å¸¸

**æµ‹è¯•é¡¹**:
1. âœ… API æ­£å¸¸æ—¶ï¼šæ··åˆæ¨¡å¼æ­£ç¡®å·¥ä½œ
2. âœ… API å¤±è´¥æ—¶ï¼šæ­£ç¡®åˆ‡æ¢åˆ°é™çº§æ¨¡å¼
3. âœ… é™çº§æ¢å¤ï¼š24å°æ—¶åè‡ªåŠ¨æ¢å¤
4. âœ… æ•°æ®å‡†ç¡®æ€§ï¼šHTML æ•°æ®æ­£ç¡®è¦†ç›– API
5. âœ… å†…å®¹è¡¥å…¨ï¼šç¼ºå¤±å†…å®¹èƒ½å¤Ÿè¡¥å…¨
6. âœ… ç¿»è¯‘è§¦å‘ï¼šè¡¥å…¨åæ­£ç¡®è§¦å‘ç¿»è¯‘

**æµ‹è¯•æ•°æ®**:
```bash
# 1. æ­£å¸¸æ¨¡å¼æµ‹è¯•
npm run worker:dev

# 2. æ¨¡æ‹Ÿ API å¤±è´¥ï¼ˆä¿®æ”¹ API URLï¼‰
SPARHAMSTER_API_URL=https://invalid.url npm run worker:dev

# 3. æ£€æŸ¥æ•°æ®åº“
psql -d moreyudeals -c "SELECT content_status, COUNT(*) FROM deals WHERE source_site='sparhamster' GROUP BY content_status;"

# 4. æ‰‹åŠ¨è§¦å‘è¡¥å…¨
npm run worker:backfill
```

**é¢„æœŸæ—¶é—´**: 2-3 å°æ—¶

---

## æµ‹è¯•æ–¹æ¡ˆ

### å•å…ƒæµ‹è¯•

```typescript
// tests/homepage-fetcher.test.ts
describe('HomepageFetcher', () => {
  it('should extract merchant name correctly', () => {
    const html = '<a title="soliver Gutscheine & Angebote">...</a>';
    const result = parseArticles(html);
    expect(result[0].merchant).toBe('soliver');
  });

  it('should parse German price format', () => {
    expect(parsePrice('13,14 â‚¬')).toBe(13.14);
    expect(parsePrice('1.108,24 â‚¬')).toBe(1108.24);
    expect(parsePrice('18,37 â‚¬')).toBe(18.37);
  });

  it('should decode HTML entities in forward links', () => {
    const link = 'https://forward.sparhamster.at/out.php?hash=xxx&amp;name=SH&amp;token=yyy';
    const decoded = decodeHtmlEntities(link);
    expect(decoded).toBe('https://forward.sparhamster.at/out.php?hash=xxx&name=SH&token=yyy');
  });
});

// tests/api-health-monitor.test.ts
describe('ApiHealthMonitor', () => {
  it('should switch to degraded mode after 3 failures', () => {
    const monitor = new ApiHealthMonitor();
    monitor.recordFailure();
    monitor.recordFailure();
    monitor.recordFailure();
    expect(monitor.checkHealth()).toBe('degraded');
  });

  it('should recover after 24 hours', async () => {
    const monitor = new ApiHealthMonitor();
    // æ¨¡æ‹Ÿ 24 å°æ—¶å
    jest.advanceTimersByTime(24 * 60 * 60 * 1000);
    expect(monitor.checkHealth()).toBe('healthy');
  });
});
```

### é›†æˆæµ‹è¯•

```bash
# 1. å¯åŠ¨æœ¬åœ°ç¯å¢ƒ
docker-compose up -d postgres redis

# 2. è¿è¡Œ Workerï¼ˆæ­£å¸¸æ¨¡å¼ï¼‰
npm run worker:dev

# 3. æ£€æŸ¥æ—¥å¿—
tail -f logs/worker.log | grep -E "(API|HTML|é™çº§)"

# 4. éªŒè¯æ•°æ®
psql -d moreyudeals -c "
  SELECT
    source_post_id,
    title,
    merchant,
    price,
    content_status
  FROM deals
  WHERE source_site = 'sparhamster'
  ORDER BY created_at DESC
  LIMIT 10;
"
```

### å‹åŠ›æµ‹è¯•

```bash
# æ¨¡æ‹Ÿé«˜é¢‘æŠ“å–
for i in {1..10}; do
  npm run worker:fetch
  sleep 30
done

# æ£€æŸ¥ API å¥åº·çŠ¶æ€
curl http://localhost:3000/api/worker/health
```

---

## ç›‘æ§å’Œå‘Šè­¦

### å…³é”®æŒ‡æ ‡

```typescript
// ç›‘æ§æŒ‡æ ‡
interface FetchMetrics {
  apiSuccessRate: number;      // API æˆåŠŸç‡
  htmlSuccessRate: number;     // HTML æˆåŠŸç‡
  averageFetchTime: number;    // å¹³å‡æŠ“å–æ—¶é—´
  degradedModeActive: boolean; // æ˜¯å¦å¤„äºé™çº§æ¨¡å¼
  missingContentCount: number; // ç¼ºå¤±å†…å®¹æ•°é‡
  backfillSuccessRate: number; // è¡¥å…¨æˆåŠŸç‡
}

// å‘Šè­¦è§„åˆ™
const alerts = {
  apiFailureRate: { threshold: 0.3, message: 'API å¤±è´¥ç‡è¶…è¿‡ 30%' },
  degradedMode: { enabled: true, message: 'å·²åˆ‡æ¢åˆ°é™çº§æ¨¡å¼' },
  missingContent: { threshold: 100, message: 'ç¼ºå¤±å†…å®¹è¶…è¿‡ 100 æ¡' },
};
```

### æ—¥å¿—è¾“å‡º

```typescript
// ç»“æ„åŒ–æ—¥å¿—
logger.info('fetch_complete', {
  mode: 'api+html',
  api_posts: 20,
  html_pages: 2,
  new_deals: 15,
  missing_content: 0,
  duration_ms: 8500,
});

logger.warn('api_degraded', {
  consecutive_failures: 3,
  degraded_until: '2025-11-12T10:00:00Z',
});

logger.info('content_backfill', {
  attempted: 50,
  succeeded: 48,
  failed: 2,
});
```

---

## å›æ»šè®¡åˆ’

### ç´§æ€¥å›æ»šæ­¥éª¤

```bash
# 1. å›æ»šä»£ç åˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬
git revert HEAD
git push origin main

# 2. æœåŠ¡å™¨æ‹‰å–
ssh user@server "cd /var/www/Moreyudeals && git pull && pm2 restart worker"

# 3. éªŒè¯å›æ»š
curl http://localhost:3000/api/worker/health

# 4. å›æ»šæ•°æ®åº“ï¼ˆå¦‚æœéœ€è¦ï¼‰
psql -d moreyudeals < backups/deals_backup_2025-11-11.sql
```

### æ•°æ®ä¿®å¤

```sql
-- å¦‚æœæ–°ç‰ˆæœ¬å¯¼è‡´æ•°æ®é”™è¯¯ï¼Œä¿®å¤è„šæœ¬ï¼š

-- 1. åˆ é™¤é”™è¯¯æ•°æ®
DELETE FROM deals
WHERE source_site = 'sparhamster'
  AND created_at > '2025-11-11 10:00:00';

-- 2. é‡ç½®ç¿»è¯‘çŠ¶æ€
UPDATE deals
SET translation_status = 'pending'
WHERE source_site = 'sparhamster'
  AND translation_status = 'failed';

-- 3. ç§»é™¤ content_status å­—æ®µï¼ˆå¦‚æœå›æ»šï¼‰
ALTER TABLE deals DROP COLUMN IF EXISTS content_status;
```

---

## æ€»ç»“

### æ”¹é€ æ”¶ç›Š

1. **æ•°æ®å‡†ç¡®æ€§æå‡ 100%**
   - ä»·æ ¼ä¿¡æ¯æ¥è‡ªçœŸå®å±•ç¤º
   - å•†å®¶ä¿¡æ¯å®Œæ•´å‡†ç¡®
   - é¿å… API æ•°æ®é”™è¯¯

2. **ç³»ç»Ÿç¨³å®šæ€§æå‡**
   - API å¤±è´¥è‡ªåŠ¨é™çº§
   - çº¯ HTML æ¨¡å¼ä¿è¯å¯ç”¨æ€§
   - 24 å°æ—¶è‡ªåŠ¨æ¢å¤

3. **æŠ“å–æ•ˆç‡ä¼˜åŒ–**
   - API å¿«é€Ÿåˆ¤æ–­æ›´æ–°
   - åŠ¨æ€å†³å®š HTML é¡µæ•°
   - å¹³å‡æŠ“å–æ—¶é—´ â‰¤ 10 ç§’

4. **ç»´æŠ¤æˆæœ¬é™ä½**
   - è‡ªåŠ¨åŒ–é™çº§å’Œæ¢å¤
   - ç¼ºå¤±å†…å®¹è‡ªåŠ¨è¡¥å…¨
   - å‡å°‘äººå·¥å¹²é¢„

### é£é™©å’ŒæŒ‘æˆ˜

1. **HTML ç»“æ„å˜åŒ–**
   - é£é™©ï¼šSparhamster ä¿®æ”¹é¡µé¢ç»“æ„
   - åº”å¯¹ï¼šç›‘æ§è§£æå¤±è´¥ç‡ï¼ŒåŠæ—¶è°ƒæ•´é€‰æ‹©å™¨

2. **æŠ“å–é¢‘ç‡é™åˆ¶**
   - é£é™©ï¼šé«˜é¢‘æŠ“å–è¢«å° IP
   - åº”å¯¹ï¼šæ¨¡æ‹Ÿäººç±»è¡Œä¸ºï¼Œéšæœºå»¶è¿Ÿï¼Œå°Šé‡ robots.txt

3. **æ•°æ®åº“å‹åŠ›**
   - é£é™©ï¼šé¢‘ç¹æ›´æ–°å½±å“æ€§èƒ½
   - åº”å¯¹ï¼šæ‰¹é‡æ“ä½œï¼Œç´¢å¼•ä¼˜åŒ–ï¼Œå®šæœŸç»´æŠ¤

### åç»­ä¼˜åŒ–æ–¹å‘

1. **æ™ºèƒ½ç¼“å­˜**
   - ç¼“å­˜é¦–é¡µ HTMLï¼ˆ5åˆ†é’Ÿï¼‰
   - å‡å°‘é‡å¤è¯·æ±‚

2. **åˆ†å¸ƒå¼æŠ“å–**
   - å¤š IP è½®æ¢
   - æé«˜æŠ“å–é€Ÿåº¦

3. **æœºå™¨å­¦ä¹ **
   - è‡ªåŠ¨è¯†åˆ« HTML ç»“æ„å˜åŒ–
   - æ™ºèƒ½è°ƒæ•´é€‰æ‹©å™¨

---

## å®æ–½ç»“æœ

### âœ… å·²å®Œæˆ (2025-11-11)

#### Phase 1-4: æ ¸å¿ƒä»£ç é‡å†™
- âœ… `homepage-fetcher.ts`: å®Œå…¨é‡å†™ï¼Œæå–15+å­—æ®µ
- âœ… `api-health-monitor.ts`: æ–°å»ºï¼Œå¥åº·æ£€æµ‹æœåŠ¡
- âœ… `sparhamster-fetcher.ts`: å®Œå…¨é‡å†™ï¼ŒåŒæ¨¡å¼æŠ“å–
- âœ… `sparhamster-normalizer.ts`: å®Œå…¨é‡å†™ï¼Œæ•°æ®åˆå¹¶é€»è¾‘

#### æµ‹è¯•ä¸ä¿®å¤
1. **é›†æˆæµ‹è¯•é€šè¿‡** (API LIMIT=30)
   - API è¿”å›: 30æ¡è®°å½• âœ…
   - HTML æŠ“å–: 10-30ç¯‡ (åŠ¨æ€åˆ¤æ–­) âœ…
   - æ•°æ®å¤„ç†: æ‰€æœ‰ HTML æ–‡ç«  âœ…
   - ç¿»è¯‘ç³»ç»Ÿ: æ­£å¸¸å·¥ä½œ âœ…

2. **å‘ç°å¹¶ä¿®å¤çš„é—®é¢˜**
   - âŒ å›¾ç‰‡æå–é”™è¯¯ (å•†å®¶ Logo æœªæ’é™¤) â†’ âœ… å·²ä¿®å¤
   - âŒ æ•°æ®åŒ¹é…ä¸å®Œæ•´ (HTML > API æ—¶ä¸¢å¤±) â†’ âœ… å·²ä¿®å¤
   - âŒ æ—¥å¿—æ˜¾ç¤º undefined â†’ âœ… å·²ä¿®å¤
   - âŒ åœæ­¢é€»è¾‘è¿‡äºä¿å®ˆ (â‰¤5åœæ­¢) â†’ âœ… æ”¹ä¸º >0 ç»§ç»­

#### æœ€ç»ˆé…ç½®
```bash
SPARHAMSTER_API_LIMIT=30
æŠ“å–ç­–ç•¥: åªè¦æœ‰æ–°æ–‡ç« å°±ç»§ç»­æŠ“å– (æœ€å¤š3é¡µ)
éšæœºå»¶è¿Ÿ: 5-15ç§’/é¡µ
æ€»è€—æ—¶: 30-60ç§’/æ¬¡æŠ“å–
```

#### æ¶æ„ä¼˜åŠ¿éªŒè¯
- âœ… APIå¥åº·ç›‘æ§ï¼šæœªè§¦å‘é™çº§ (API æ­£å¸¸)
- âœ… æ•°æ®å®Œæ•´æ€§ï¼šHTML æä¾›å‡†ç¡®ä»·æ ¼/å•†å®¶
- âœ… è”ç›Ÿé“¾æ¥ï¼šAmazon è§£ææ­£å¸¸ï¼ŒæˆåŠŸæ·»åŠ è”ç›Ÿç 
- âœ… å»é‡ç³»ç»Ÿï¼šæ­£ç¡®è¯†åˆ«é‡å¤å¹¶æ›´æ–°
- âœ… ç¿»è¯‘ç³»ç»Ÿï¼šmicrosoft ä¼˜å…ˆçº§æ­£ç¡®

### ğŸ“Š æ€§èƒ½æ•°æ®

**æŠ“å–æ€§èƒ½**:
- API è¯·æ±‚: ~1ç§’
- HTML æŠ“å–: 5-15ç§’/é¡µ
- æ€»è€—æ—¶: çº¦ 30-60ç§’ (å«éšæœºå»¶è¿Ÿ)
- å¤„ç†é€Ÿåº¦: ~1ç§’/ç¯‡æ–‡ç« 

**æ•°æ®è´¨é‡**:
- æ–°å¢æ–‡ç« : ç«‹å³æŠ“å– + ç¿»è¯‘
- é‡å¤æ£€æµ‹: å‡†ç¡®ç‡ 100%
- å•†å®¶è¯†åˆ«: å‡†ç¡® (HTML æå–)
- ä»·æ ¼å‡†ç¡®æ€§: é«˜ (HTML > API)

### ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

1. **ç›‘æ§ç”Ÿäº§ç¯å¢ƒè¡¨ç°** (1-2å‘¨)
   - API å¥åº·çŠ¶æ€
   - é™çº§åˆ‡æ¢é¢‘ç‡
   - æ•°æ®å®Œæ•´æ€§

2. **ä¼˜åŒ–å»ºè®®** (å¯é€‰)
   - ç¼“å­˜æœºåˆ¶ (å‡å°‘é‡å¤è¯·æ±‚)
   - åˆ†å¸ƒå¼æŠ“å– (å¦‚éœ€è¦)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0
**æœ€åæ›´æ–°**: 2025-11-11
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶ä¸Šçº¿
**ç»´æŠ¤è€…**: Moreyudeals Team
