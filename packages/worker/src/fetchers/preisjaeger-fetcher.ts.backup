/**
 * Preisjaeger Fetcher
 *
 * è´Ÿè´£æŠ“å– Preisjaeger.at çš„ä¼˜æƒ æ•°æ®
 *
 * æŠ“å–ç­–ç•¥ï¼š
 * 1. æŠ“å–åˆ—è¡¨é¡µï¼ˆ/neuï¼‰ï¼Œä» data-vue3 å±æ€§è§£æ JSON
 * 2. æå– threadId åˆ—è¡¨
 * 3. å»é‡æ£€æŸ¥ï¼ˆè¿‡æ»¤å·²å­˜åœ¨çš„ threadIdï¼‰
 * 4. é™åˆ¶è¯¦æƒ…é¡µæ•°é‡ï¼ˆæœ€å¤š 20 ä¸ªï¼‰
 * 5. æŠ“å–è¯¦æƒ…é¡µï¼Œä» window.__INITIAL_STATE__.threadDetail è§£æ JSON
 * 6. éšæœºå»¶è¿Ÿ 5-15 ç§’ï¼ˆé¿å…è¢«é™åˆ¶ï¼‰
 *
 * æ•°æ®æ¥æºï¼š
 * - åˆ—è¡¨é¡µï¼šhttps://www.preisjaeger.at/neu
 * - è¯¦æƒ…é¡µï¼šhttps://www.preisjaeger.at/deals/{titleSlug}-{threadId}
 */

import axios from 'axios';
import { load as cheerioLoad } from 'cheerio';
import { DatabaseManager } from '../database';
import { PreisjaegerNormalizer, PreisjaegerListItem, PreisjaegerDetailItem } from '../normalizers/preisjaeger-normalizer';
import { DeduplicationService } from '../services/deduplication-service';
import { AffiliateLinkService } from '../services/affiliate-link-service';
import { FetchResult } from '../types/fetcher.types';
import { Deal } from '../types/deal.types';

// é…ç½®
const LIST_URL = process.env.PREISJAEGER_LIST_URL || 'https://www.preisjaeger.at/neu';
const MAX_DETAIL_PAGES = Number(process.env.PREISJAEGER_MAX_DETAIL_PAGES || '20');
const DETAIL_MIN_DELAY = Number(process.env.PREISJAEGER_DETAIL_MIN_DELAY || '5000'); // 5ç§’
const DETAIL_MAX_DELAY = Number(process.env.PREISJAEGER_DETAIL_MAX_DELAY || '15000'); // 15ç§’

/**
 * Preisjaeger Fetcher
 */
export class PreisjaegerFetcher {
  private readonly normalizer: PreisjaegerNormalizer;
  private readonly deduplicator: DeduplicationService;
  private readonly affiliateLinkService: AffiliateLinkService;

  constructor(private readonly database: DatabaseManager) {
    this.normalizer = new PreisjaegerNormalizer();
    this.deduplicator = new DeduplicationService(database);
    this.affiliateLinkService = new AffiliateLinkService();
  }

  /**
   * ä¸»æŠ“å–æ–¹æ³•
   *
   * æµç¨‹ï¼š
   * 1. æŠ“å–åˆ—è¡¨é¡µï¼Œæå– threadId åˆ—è¡¨
   * 2. å»é‡æ£€æŸ¥ï¼ˆè¿‡æ»¤å·²å­˜åœ¨çš„ï¼‰
   * 3. é™åˆ¶æ•°é‡ï¼ˆæœ€å¤š 20 ä¸ªï¼‰
   * 4. é€ä¸ªæŠ“å–è¯¦æƒ…é¡µï¼ˆå¸¦å»¶è¿Ÿï¼‰
   * 5. æ ‡å‡†åŒ–æ•°æ®
   * 6. å¤„ç†è”ç›Ÿé“¾æ¥
   * 7. å»é‡å’Œå…¥åº“
   */
  async fetchLatest(): Promise<FetchResult> {
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('ğŸš€ å¼€å§‹æŠ“å– Preisjaeger');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

    const result: FetchResult = {
      fetched: 0,
      inserted: 0,
      updated: 0,
      duplicates: 0,
      errors: [],
    };

    try {
      // Step 1: æŠ“å–åˆ—è¡¨é¡µ
      console.log(`ğŸ“¡ æŠ“å–åˆ—è¡¨é¡µ: ${LIST_URL}`);
      const listItems = await this.fetchListPage();
      console.log(`ğŸ“¥ åˆ—è¡¨é¡µè¿”å› ${listItems.length} æ¡è®°å½•`);

      if (listItems.length === 0) {
        console.log('âœ“ åˆ—è¡¨é¡µæ— æ•°æ®ï¼Œè·³è¿‡');
        return result;
      }

      // Step 2: å»é‡æ£€æŸ¥
      const existingThreadIds = await this.getExistingThreadIds();
      const newItems = listItems.filter(item => !existingThreadIds.has(item.threadId));

      console.log(`ğŸ“Š æ–°å•†å“æ•°é‡: ${newItems.length}/${listItems.length}`);

      if (newItems.length === 0) {
        console.log('âœ“ æ— æ–°å•†å“ï¼Œè·³è¿‡è¯¦æƒ…é¡µæŠ“å–');
        return result;
      }

      // Step 3: é™åˆ¶æ•°é‡
      const itemsToFetch = newItems.slice(0, MAX_DETAIL_PAGES);
      if (newItems.length > MAX_DETAIL_PAGES) {
        console.log(`âš ï¸  æ–°å•†å“è¶…è¿‡é™åˆ¶ï¼ŒåªæŠ“å–å‰ ${MAX_DETAIL_PAGES} ä¸ª`);
      }

      result.fetched = itemsToFetch.length;

      // Step 4: ä½¿ç”¨åˆ—è¡¨é¡µæ•°æ®å¿«é€Ÿå†™å…¥
      const newDeals: Array<{ listItem: PreisjaegerListItem; dealId: string }> = []; // è®°å½•æ–°æ’å…¥çš„å•†å“åŠå…¶ID
      for (let i = 0; i < itemsToFetch.length; i++) {
        const listItem = itemsToFetch[i];

        try {
          // ä½¿ç”¨åˆ—è¡¨é¡µæ•°æ®æ ‡å‡†åŒ–
          console.log(`ğŸ“¦ [${i + 1}/${itemsToFetch.length}] å¤„ç†å•†å“(åˆ—è¡¨é¡µ): ${listItem.title}`);
          const deal = await this.normalizer.normalizeFromList(listItem);

          // å»é‡æ£€æŸ¥
          const dupResult = await this.deduplicator.checkDuplicate(deal);

          if (dupResult.isDuplicate && dupResult.existingDeal) {
            // é‡å¤è®°å½•,è·³è¿‡
            result.duplicates++;
            console.log(`ğŸ” é‡å¤: ${deal.titleDe}`);
          } else {
            // æ’å…¥æ–°è®°å½• (åˆ—è¡¨é¡µæ•°æ®)
            const newDealId = await this.database.createDeal(deal);
            newDeals.push({ listItem, dealId: newDealId }); // è®°å½•å•†å“å’ŒIDçš„å¯¹åº”å…³ç³»
            result.inserted++;
            console.log(`âœ… æ–°å¢(åˆ—è¡¨é¡µ): ${deal.titleDe}`);
          }
        } catch (error) {
          const errorMsg = `å¤„ç† Thread ${listItem.threadId} å¤±è´¥: ${(error as Error).message}`;
          console.error(`âŒ ${errorMsg}`);
          result.errors.push(errorMsg);
        }
      }

      // Step 5: æŠ“å–æ–°å•†å“çš„è¯¦æƒ…é¡µå¹¶æ›´æ–°æ•°æ®åº“
      if (newDeals.length > 0) {
        console.log(`\nğŸ” å¼€å§‹æŠ“å– ${newDeals.length} ä¸ªæ–°å•†å“çš„è¯¦æƒ…é¡µ...\n`);

        for (let i = 0; i < newDeals.length; i++) {
          const { listItem, dealId } = newDeals[i];

          try {
            // éšæœºå»¶è¿Ÿ(ç¬¬ä¸€ä¸ªä¸å»¶è¿Ÿ)
            if (i > 0) {
              const delay = this.getRandomDelay(DETAIL_MIN_DELAY, DETAIL_MAX_DELAY);
              console.log(`â³ å»¶è¿Ÿ ${(delay / 1000).toFixed(1)} ç§’...`);
              await this.sleep(delay);
            }

            // æŠ“å–è¯¦æƒ…é¡µ
            console.log(`ğŸ“„ [${i + 1}/${newDealsIds.length}] æŠ“å–è¯¦æƒ…é¡µ: ${listItem.title}`);
            const detailItem = await this.fetchDetailPage(listItem, i < 3); // å‰3ä¸ªä¿å­˜HTML

            // é‡æ–°æ ‡å‡†åŒ–(ä½¿ç”¨è¯¦æƒ…é¡µæ•°æ®)
            const updatedDeal = await this.normalizer.normalize(detailItem);

            // åˆ é™¤ id å­—æ®µ,ä½¿ç”¨ dealId ä½œä¸ºæ›´æ–°æ¡ä»¶
            delete (updatedDeal as any).id;

            // æ›´æ–°æ•°æ®åº“
            await this.database.updateDeal(dealId, updatedDeal);
            result.updated++;
            console.log(`ğŸ”„ æ›´æ–°(è¯¦æƒ…é¡µ): ${updatedDeal.titleDe}`);
          } catch (error) {
            const errorMsg = `æŠ“å–è¯¦æƒ…é¡µå¤±è´¥ Thread ${listItem.threadId}: ${(error as Error).message}`;
            console.warn(`âš ï¸  ${errorMsg} (ä¿ç•™åˆ—è¡¨é¡µæ•°æ®)`);
            result.errors.push(errorMsg);
          }
        }
      }

      console.log('\nğŸ“Š æŠ“å–ç»Ÿè®¡:');
      console.log(`   - æŠ“å–: ${result.fetched}`);
      console.log(`   - æ–°å¢: ${result.inserted}`);
      console.log(`   - é‡å¤: ${result.duplicates}`);
      console.log(`   - é”™è¯¯: ${result.errors.length}`);

      return result;
    } catch (error) {
      const errorMsg = `Preisjaeger æŠ“å–å¤±è´¥: ${(error as Error).message}`;
      console.error(`âŒ ${errorMsg}`);
      result.errors.push(errorMsg);
      return result;
    }
  }

  /**
   * æŠ“å–åˆ—è¡¨é¡µå¹¶è§£æ data-vue3 å±æ€§
   *
   * @returns PreisjaegerListItem åˆ—è¡¨
   */
  private async fetchListPage(): Promise<PreisjaegerListItem[]> {
    const response = await axios.get(LIST_URL, {
      headers: {
        'User-Agent': process.env.PREISJAEGER_USER_AGENT ||
          'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
        'Accept-Language': 'de-AT,de;q=0.9,en-US;q=0.8,en;q=0.7',
        'Accept-Encoding': 'gzip, deflate, br',
        'Referer': 'https://www.preisjaeger.at/',
        'Connection': 'keep-alive',
        'Cache-Control': 'no-cache',
      },
      timeout: 30000,
    });

    const html = response.data;
    const $ = cheerioLoad(html);

    // æŸ¥æ‰¾æ‰€æœ‰åŒ…å« data-vue3 å±æ€§çš„å…ƒç´ 
    const items: PreisjaegerListItem[] = [];

    $('[data-vue3]').each((_, element) => {
      try {
        const dataVue3 = $(element).attr('data-vue3');
        if (!dataVue3) return;

        // è§£æ JSON
        const vueData = JSON.parse(dataVue3);

        // æ£€æŸ¥æ˜¯å¦æ˜¯ ThreadMainListItemNormalizer ç»„ä»¶ï¼ˆåŒ…å« thread æ•°æ®ï¼‰
        if (vueData.name === 'ThreadMainListItemNormalizer' && vueData.props?.thread) {
          const thread = vueData.props.thread as PreisjaegerListItem;

          // åŸºæœ¬éªŒè¯
          if (thread.threadId && thread.title) {
            // ä» JSON metadata ä¸­æå–ç®€çŸ­æè¿°ä½œä¸ºä¸´æ—¶ description
            // @ts-ignore - metadata å¯èƒ½å­˜åœ¨äº thread ä¸­
            const metadata = thread.metadata;
            if (metadata?.description) {
              thread.descriptionHtml = metadata.description;
            }

            items.push(thread);
          }
        }
      } catch (error) {
        // è§£æå¤±è´¥ï¼Œè·³è¿‡
        console.warn(`è§£æ data-vue3 å¤±è´¥: ${(error as Error).message}`);
      }
    });

    return items;
  }

  /**
   * æŠ“å–è¯¦æƒ…é¡µå¹¶è§£æ window.__INITIAL_STATE__.threadDetail
   *
   * @param listItem - åˆ—è¡¨é¡µæ•°æ®ï¼ˆç”¨äºæ„å»º URLï¼‰
   * @param saveHtml - æ˜¯å¦ä¿å­˜HTMLåˆ°æ–‡ä»¶(ç”¨äºè°ƒè¯•)
   * @returns è¯¦æƒ…é¡µå®Œæ•´æ•°æ®
   */
  private async fetchDetailPage(listItem: PreisjaegerListItem, saveHtml: boolean = false): Promise<PreisjaegerDetailItem> {
    // æ„å»ºè¯¦æƒ…é¡µ URL
    const detailUrl = `https://www.preisjaeger.at/deals/${listItem.titleSlug}-${listItem.threadId}`;

    const response = await axios.get(detailUrl, {
      headers: {
        'User-Agent': process.env.PREISJAEGER_USER_AGENT ||
          'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
        'Accept-Language': 'de-AT,de;q=0.9,en-US;q=0.8,en;q=0.7',
        'Accept-Encoding': 'gzip, deflate, br',
        'Referer': LIST_URL,
        'Connection': 'keep-alive',
        'Cache-Control': 'no-cache',
      },
      timeout: 30000,
    });

    const html = response.data;

    // ä¿å­˜HTMLåˆ°æ–‡ä»¶(è°ƒè¯•ç”¨)
    if (saveHtml) {
      try {
        const fs = await import('fs/promises');
        const path = `/tmp/thread_${listItem.threadId}.html`;
        await fs.writeFile(path, html, 'utf-8');
        console.log(`   ğŸ’¾ å·²ä¿å­˜HTML: ${path}`);
      } catch (error) {
        console.warn(`   âš ï¸  ä¿å­˜HTMLå¤±è´¥: ${(error as Error).message}`);
      }
    }

    // ä» HTML ä¸­æå– window.__INITIAL_STATE__
    const initialStateMatch = html.match(/window\.__INITIAL_STATE__\s*=\s*({.+?});/s);

    if (!initialStateMatch) {
      throw new Error(`æ— æ³•ä»è¯¦æƒ…é¡µæå– __INITIAL_STATE__: ${detailUrl}`);
    }

    try {
      const initialState = JSON.parse(initialStateMatch[1]);

      // æå– threadDetail
      const threadDetail = initialState.threadDetail;

      if (!threadDetail || !threadDetail.threadId) {
        throw new Error('threadDetail æ•°æ®ä¸å®Œæ•´');
      }

      return threadDetail as PreisjaegerDetailItem;
    } catch (error) {
      throw new Error(`è§£æ __INITIAL_STATE__ å¤±è´¥: ${(error as Error).message}`);
    }
  }

  /**
   * è·å–æ•°æ®åº“ä¸­å·²å­˜åœ¨çš„ threadId
   */
  private async getExistingThreadIds(): Promise<Set<string>> {
    const existingDeals = await this.database.query(
      `SELECT source_post_id FROM deals WHERE source_site = 'preisjaeger' LIMIT 1000`
    ) as { source_post_id: string }[];

    return new Set(existingDeals.map(d => d.source_post_id));
  }

  /**
   * è·å–éšæœºå»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
   */
  private getRandomDelay(min: number, max: number): number {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  /**
   * ä¼‘çœ 
   */
  private sleep(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
